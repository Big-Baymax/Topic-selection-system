{extend name="base/tablebase"/}{block name="title"}分组管理{/block}{block name="css"}<style>    input[type="radio"],    input[type="checkbox"] {        margin: -3px 5px 0px 0px;        *margin-top: 0;        /* IE7 */        margin-top: -3px;        /* IE8-9 */        line-height: normal;    }    .ms-drop ul > li label.optgroup {        font-weight: bold;        font-size: 15px;        color: #ff0000;    }</style>{/block}{block name="table"}<!-- Example Card View --><div class="example-wrap">    <div class="example">        <div class="btn-group hidden-xs" id="exampleToolbar" role="group">            <button type="button" class="btn btn-outline btn-default" id="add" data-toggle="tooltip" data-animation="false" data-original-title="添加">                <i class="glyphicon glyphicon-plus" aria-hidden="true"></i>            </button>            <button type="button" class="btn btn-outline btn-default" id="defriend" data-toggle="tooltip" data-animation="false" data-original-title="禁用">                <i class="glyphicon glyphicon-ban-circle" aria-hidden="true"></i>            </button>            <button type="button" class="btn btn-outline btn-default" id="del" data-toggle="tooltip" data-animation="false" data-original-title="删除">                <i class="glyphicon glyphicon-trash" aria-hidden="true"></i>            </button>            <button type="button" class="btn btn-outline btn-default" id="edit" data-toggle="tooltip" data-animation="false" data-original-title="修改">                <i class="glyphicon glyphicon-edit" aria-hidden="true"></i>            </button>        </div>        <table id="table" data-toggle="table" data-card-view="true" data-mobile-responsive="true" data-click-to-select="true" data-unique-id="id" data-show-export="true">            <thead>            <tr>                <th data-field="state" data-checkbox="true"></th>                <th data-field="id">UID</th>                <th data-field="title" data-sortable="true">组名</th>                <th data-field="status" data-formatter="statusFormatter" data-align="center" data-halign="center">状态</th>                <th data-field="cre_time" data-sortable="true">创建时间</th>                <th data-formatter="buttonFormatter" data-align="center" data-halign="center">成员管理</th>            </tr>            </thead>        </table>    </div></div><!-- End Example Card View -->{/block}{block name="model"}<div class="modal fade add-model" tabindex="-1" role="dialog">    <div class="modal-dialog" role="document">        <div class="modal-content">            <div class="modal-header">                <button type="button" class="close" data-dismiss="modal" aria-label="Close">                    <span aria-hidden="true">&times;</span>                </button>                <h4 class="modal-title">添加</h4>            </div>            <div class="modal-body">                <form method="post" id="add-form">                    <div class="form-group">                        <label>组名</label>                        <input type="text" name="title" placeholder="请输入组名" class="form-control" required="required">                    </div>                    <div class="form-group">                        <label>权限选择</label>                        <select multiple="multiple" id="rule" name="rules[]" required="required">                        </select>                    </div>                </form>            </div>            <div class="modal-footer">                <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>                <button id="add-confirm" type="button" class="btn btn-primary">确定</button>            </div>        </div>    </div></div><div class="modal fade edit-model" tabindex="-1" role="dialog">    <div class="modal-dialog" role="document">        <div class="modal-content">            <div class="modal-header">                <button type="button" class="close" data-dismiss="modal" aria-label="Close">                    <span aria-hidden="true">&times;</span>                </button>                <h4 class="modal-title">修改</h4>            </div>            <div class="modal-body">                <form method="post" id="edit-form">                    <div class="form-group">                        <label>组名</label>                        <input type="text" id="B-title" name="title" placeholder="请输入组名" class="form-control" required="required">                    </div>                    <div class="form-group">                        <label>权限选择</label>                        <select multiple="multiple" id="rule-edit" name="rules[]" required="required">                        </select>                    </div>                </form>            </div>            <div class="modal-footer">                <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>                <button id="edit-confirm" type="button" class="btn btn-primary">确定</button>            </div>        </div>    </div></div><div class="modal fade member-model" tabindex="-1" role="dialog">    <div class="modal-dialog modal-lg" role="document">        <div class="modal-content">            <div class="modal-header">                <button type="button" class="close" data-dismiss="modal" aria-label="Close">                    <span aria-hidden="true">&times;</span>                </button>                <h4 class="modal-title" id="member-title">成员编辑</h4>            </div>            <div class="modal-body">                <!--内容-->                <div class="example-wrap">                    <div class="example">                        <div class="btn-group" id="member-exampleToolbar" role="group">                            <div class="btn-group">                                <form method="post" id="add-member">                                <select class="form-control dropdown-toggle" id="B-uid" name="uid" placeholder="请选择要添加的用户" required="required">                                    <option value="" style="display: none">请选择您要添加的用户</option>                                    {volist name="list" id="data" empty="暂时没有数据"}                                    <option value="{$data.uid}">{$data.name}({$data.login_name})</option>                                    {/volist}                                </select>                                    <input type="text" id="group-id" name="group_id" required="required" style="display: none">                                </form>                            </div>                            <button type="button" class="btn btn-outline btn-default" id="member-add" data-toggle="tooltip" data-animation="false" data-original-title="添加">                                <i class="glyphicon glyphicon-plus" aria-hidden="true"></i>                            </button>                            <button type="button" class="btn btn-outline btn-default" id="member-del" data-toggle="tooltip" data-animation="false" data-original-title="删除">                                <i class="glyphicon glyphicon-trash" aria-hidden="true"></i>                            </button>                        </div>                        <table id="member-table" data-toggle="table" data-card-view="true" data-mobile-responsive="true" data-click-to-select="true" data-unique-id="id" data-show-export="true">                            <thead>                            <tr>                                <th data-field="state" data-checkbox="true"></th>                                <th data-field="uid">用户UID</th>                                <th data-field="group_id">分组ID</th>                                <th data-field="cre_time" data-sortable="true">添加时间</th>                                <th data-field="up_time" data-sortable="true">修改时间</th>                            </tr>                            </thead>                        </table>                    </div>                </div>            </div>        </div>    </div></div>{/block}{block name="linkjs"}<script src="_JS_/plugins/multiple-select/multiple-select.js"></script>{/block}{block name="js"}<script>    $(document).on('show.bs.modal', '.modal', function(event) {        $(this).appendTo($('body'));    }).on('shown.bs.modal', '.modal.in', function(event) {        setModalsAndBackdropsOrder();    }).on('hidden.bs.modal', '.modal', function(event) {        setModalsAndBackdropsOrder();    });    function setModalsAndBackdropsOrder() {        var modalZIndex = 1040;        $('.modal.in').each(function(index) {            var $modal = $(this);            modalZIndex++;            $modal.css('zIndex', modalZIndex);            $modal.next('.modal-backdrop.in').addClass('hidden').css('zIndex', modalZIndex - 1);        });        $('.modal.in:visible:last').focus().next('.modal-backdrop.in').removeClass('hidden');    }</script><script>    var rule = {$rule};    var html = '';    for(var val in rule){        html += '<optgroup label="'+val+'">'        for(var data in rule[val]){           html += ' <option value="'+rule[val][data]['id']+'" title="'+rule[val][data]['title']+'">'+rule[val][data]['title']+'</option>'        }        html +='</optgroup>';    }    $("#rule").html(html);    $("#rule-edit").html(html);    var rule =  $("#rule").multipleSelect({        multiple: true,        multipleWidth: 150,        selectAllText:"全选",        placeholder:'点击选择您要安排的权限',        countSelected: '选中 # 组，共 % 项',        width: '100%',    });    var rule_edit =  $("#rule-edit").multipleSelect({        multiple: true,        multipleWidth: 150,        selectAllText:"全选",        placeholder:'点击选择您要安排的权限',        countSelected: '选中 # 组，共 % 项',        width: '100%',    });    //设置选中    //rule_edit.multipleSelect('setSelects', [1,2,3,5,8]);    rule.change(function() {        console.log($(this).val());        console.log('123');    })    $("#text").click(function () {        console.log(rule.multipleSelect('getSelects'));        console.log(rule.multipleSelect('getSelects', 'text'));    });    $.validator.setDefaults({        highlight: function (e) {            $(e).closest(".form-group").removeClass("has-success").addClass("has-error")        },        success: function (e) {            e.closest(".form-group").removeClass("has-error").addClass("has-success")        },        errorElement: "span",        errorPlacement: function (e, r) {            e.appendTo(r.is(":radio") || r.is(":checkbox") ? r.parent().parent().parent() : r.parent())        },        errorClass: "help-block m-b-none",        validClass: "help-block m-b-none",    })    $('#table').bootstrapTable({        search: true,        pagination: true,        url: '_URL_/admin/admin/group_list',        showRefresh: true,        showToggle: true,        showColumns: true,        method: 'post',        height: 600,        pageSize: 10,        pageNumber: 1,//开始的时候是第几页        pageList: [5, 10, 15, 25,'ALL'],        sidePagination: "server",        queryParamsType: '',        dataField:'data',//指定        exportTypes: ['json', 'xml', 'csv', 'txt', 'sql', 'excel'],        exportOptions: {fileName: '导出'},        toolbar: "#exampleToolbar",        iconSize: "outline",        sortOrder:"desc",        icons: {            refresh: "glyphicon-repeat",            toggle: "glyphicon-list-alt",            columns: "glyphicon-list",            export: 'glyphicon glyphicon-export'        }    });    var member_table = $('#member-table').bootstrapTable({        search: true,        pagination: true,        url: '_URL_/admin/access_list/1',        showRefresh: true,        showToggle: true,        showColumns: true,        method: 'post',        height: 350,        pageSize: 10,        pageNumber: 1,//开始的时候是第几页        pageList: [5, 10, 15, 25,'ALL'],        queryParamsType: '',        sidePagination: "server",        dataField:'data',//指定        exportTypes: ['json', 'xml', 'csv', 'txt', 'sql', 'excel'],        exportOptions: {fileName: '导出'},        toolbar: "#member-exampleToolbar",        iconSize: "outline",        sortOrder:"desc",        icons: {            refresh: "glyphicon-repeat",            toggle: "glyphicon-list-alt",            columns: "glyphicon-list",            export: 'glyphicon glyphicon-export'        }    });    function statusFormatter(value, row, index) {        if (value == 1) {            return '<a class="label label-primary defriend" href="#" data_id="'+row.id+'">启用</a>'        } else {            return '<a class="label label-danger defriend" href="#"  data_id="'+row.id+'">不启用</a>'        }    }    function buttonFormatter(value, row, index) {        return '<a class="label label-success member" href="#" data_id="'+row.id+'" data_name="'+row.title+'">成员管理</a>'    }    $(document).ready(function () {        // Tooltip        $('[data-toggle="tooltip"]').tooltip({            trigger: 'hover'        });        $("#add").click(function () {            $('.add-model').modal('toggle');        })        $("#edit").click(function () {            var data_id = $('#table').bootstrapTable('getAllSelections');            if (data_id.length > 1) {                layer.msg('选择多个将默认第一个哦！', {icon: 6});                $('.edit-model').modal('toggle');            } else if(data_id.length<1) {                layer.msg('需要先选择数据行哦！', {icon: 0});                return false;            }else{                $('.edit-model').modal('toggle');            }            $('#edit-form').setform(data_id[0], 'B-');            $('#edit-form').attr('data_id',data_id[0]['id']);            rule_edit.multipleSelect('setSelects', data_id[0]['rules'].split(','));        })        //添加信息        $("#add-confirm").click(function () {            if($('#add-form').validate().form()){                $.ajax({                    url: 'admin/group_add',                    type: 'POST',                    data: $('#add-form').serialize(),                    success: function (result) {                        if (result.status) {                            //status为1成功                            layer.msg('' + result.msg, {icon: 1});                            $('#table').bootstrapTable('refresh');                            $('.add-model').modal('toggle');                            $('#add-form input').val("");                        } else {                            layer.msg('' + result.msg, {icon: 2});                        }                    },                    error:function () {                        layer.msg('网络开小差了!', {icon: 5});                    }                });            }        })        //编辑提交信息        $("#edit-confirm").click(function () {            if($('#edit-form').validate().form()){                $.ajax({                    url: 'admin/group_edit/'+$('#edit-form').attr('data_id'),                    type: 'POST',                    data: $('#edit-form').serialize(),                    success: function (result) {                        if (result.status) {                            //status为1成功                            layer.msg('' + result.msg, {icon: 1});                            $('#table').bootstrapTable('refresh');                            $('.edit-model').modal('toggle');                        } else {                            layer.msg('' + result.msg, {icon: 2});                        }                    },                    error:function () {                        layer.msg('网络开小差了!', {icon: 5});                    }                });            }        })        //获取表格数据        function get_id_group(table) {            var data_id = table.bootstrapTable('getSelections');            var id_arr = [];            if (data_id.length) {                for (var i = 0; i < data_id.length; i++) {                    id_arr.push(data_id[i].id);                }                return id_arr;            } else {                layer.msg('需要先选择数据行哦！', {icon: 0});            }        }        //删除分组        $("#del").click(function () {            var id_arr = get_id_group($('#table'));            //判断是否有数据            if (id_arr) {                //询问框                layer.confirm('确定删除UID为【' + id_arr.join('，') + '】的行吗？', {                    btn: ['确定', '取消'],//按钮                    skin: 'layui-layer-molv' //样式类名                }, function () {                    //请求后台                    $.ajax({                        url: 'admin/group_del',                        type: 'POST',                        data: {                            uid:id_arr                        },                        success: function (result) {                            if (result.status) {                                //status为1成功                                layer.msg('' + result.msg, {icon: 1});                                var data_id = $('#table').bootstrapTable('getSelections');                                //$('#table').bootstrapTable('removeAll');                                if (data_id.length) {                                    for (var i = 0; i < data_id.length; i++) {                                        $('#table').bootstrapTable('removeByUniqueId', data_id[i].id);                                    }                                }                            } else {                                layer.msg('' + result.msg, {icon: 2});                            }                        },                        error:function () {                            layer.msg('网络开小差了!', {icon: 5});                        }                    });                });            }        });        $("#defriend").click(function () {            var id_arr = get_id_group($('#table'));            //判断是否有数据            if (id_arr) {                //询问框                layer.confirm('确定更改UID为【' + id_arr.join('，') + '】的状态吗？', {                    btn: ['确定', '取消'],//按钮                    skin: 'layui-layer-molv' //样式类名                }, function () {                    //请求后台                    $.ajax({                        url: 'admin/group_defriend',                        type: 'POST',                        data: {                            uid:id_arr                        },                        success: function (result) {                            if (result.status) {                                //status为1成功                                layer.msg('' + result.msg, {icon: 1});                                $('#table').bootstrapTable('refresh');                            } else {                                layer.msg('' + result.msg, {icon: 2});                            }                        },                        error:function () {                            layer.msg('网络开小差了!', {icon: 5});                        }                    });                });            }        })        //单击禁用操做        $('#table').on('click','.defriend',function (event) {            $('#table').bootstrapTable('uncheckAll');            var id_arr = [];            id_arr.push($(this).attr('data_id'));            //请求后台            $.ajax({                url: 'admin/group_defriend',                type: 'POST',                data: {                    uid:id_arr                },                success: function (result) {                    if (result.status) {                        //status为1成功                        layer.msg('' + result.msg, {icon: 1});                        $('#table').bootstrapTable('refresh');                    } else {                        layer.msg('' + result.msg, {icon: 2});                    }                },                error:function () {                    layer.msg('网络开小差了!', {icon: 5});                }            });            //防止冒泡            return false;        });        //触发成员管理窗口        $('#table').on('click','.member',function (event) {            $('#table').bootstrapTable('uncheckAll');            var id =$(this).attr('data_id');            $("#group-id").val(id);            $('#member-title').html('【'+$(this).attr('data_name')+'】小组成员编辑');            $('.member-model').modal('toggle');            $('#member-table').bootstrapTable('refresh',{'url':'_URL_/admin/access_list/'+id});            //防止冒泡            return false;        })        //删除成员        $("#member-add").click(function () {            console.log($("#group-id").val());            if($("#B-uid").val() != ''){                $.ajax({                    url: 'admin/access_add',                    type: 'POST',                    data: $('#add-member').serialize(),                    success: function (result) {                        if (result.status) {                            //status为1成功                            layer.msg('' + result.msg, {icon: 1});                            $('#member-table').bootstrapTable('refresh');                        } else {                            layer.msg('' + result.msg, {icon: 2});                        }                    },                    error:function () {                        layer.msg('网络开小差了!', {icon: 5});                    }                });            }else{                layer.msg('请选择要添加的用户!', {icon: 5});            }        })        //删除成员        $("#member-del").click(function () {            var id_arr = get_id_group($('#member-table'));            //判断是否有数据            if (id_arr) {                //询问框                layer.confirm('确定删除UID为【' + id_arr.join('，') + '】的行吗？', {                    btn: ['确定', '取消'],//按钮                    skin: 'layui-layer-molv' //样式类名                }, function () {                    //请求后台                    $.ajax({                        url: 'admin/access_del',                        type: 'POST',                        data: {                            uid:id_arr                        },                        success: function (result) {                            if (result.status) {                                //status为1成功                                layer.msg('' + result.msg, {icon: 1});                                var data_id = $('#member-table').bootstrapTable('getSelections');                                //$('#table').bootstrapTable('removeAll');                                if (data_id.length) {                                    for (var i = 0; i < data_id.length; i++) {                                        $('#member-table').bootstrapTable('removeByUniqueId', data_id[i].id);                                    }                                }                            } else {                                layer.msg('' + result.msg, {icon: 2});                            }                        },                        error:function () {                            layer.msg('网络开小差了!', {icon: 5});                        }                    });                });            }        });    });</script>{/block}